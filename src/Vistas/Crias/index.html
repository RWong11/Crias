<html lang="es">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../Contenido/css/bootstrap.min.css">
    <link rel="stylesheet" href="../Contenido/css/font-awesome.min.css">
    <link rel="stylesheet" href="../Contenido/css/vista.css">
    <link rel="stylesheet" href="../Contenido/css/sweetalert2.min.css">
    <link rel="stylesheet" href="../Contenido/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="../Contenido/css/buttons.bootstrap4.min.css">
    
    <script src="../Contenido/js/jquery-3.4.1.min.js"></script>
    <script src="../Contenido/js/jquery.dataTables.min.js"></script>
    <script src="../Contenido/js/dataTables.bootstrap4.min.js"></script>
    <script src="../Contenido/js/dataTables.buttons.min.js"></script>
    <script src="../Contenido/js/buttons.bootstrap4.min.js"></script>
    <script src="../Contenido/js/jszip.min.js"></script>
    <script src="../Contenido/js/pdfmake.min.js"></script>
    <script src="../Contenido/js/vfs_fonts.js"></script>
    <script src="../Contenido/js/buttons.html5.min.js"></script>
    <script src="../Contenido/js/buttons.print.min.js"></script>
    <script src="../Contenido/js/buttons.colVis.min.js"></script>
    <script src="../Contenido/js/popper.min.js"></script>
    <script src="../Contenido/js/bootstrap.min.js"></script>
    <script src="../Contenido/js/sweetalert2.min.js"></script>
    
    <style>
    .swal-wide{
        width:60% !important;
    }
    td.details-control {
        background: url('../Contenido/images/details_open.png') no-repeat center center;
        cursor: pointer;
    }
    tr.shown td.details-control {
        background: url('../Contenido/images/details_close.png') no-repeat center center;
    }
	</style>
  </head>
  <body>
  <div class = "main">
    <h1 class="display-4" align="center">Crias</h1>
    <table id="tablaCrias" class="table table-striped table-bordered" style="width:100%;">
        <thead>
            <tr>
            	<th>+</th>
            	<th>No. Cria</th>
                <th>Clasificación</th>
                <th>Estado</th>
                <th>Corral</th>
                <th>Proceso actual</th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr>
                <th>+</th>
                <th>No. Cria</th>
                <th>Clasificación</th>
                <th>Estado</th>
                <th>Corral</th>
                <th>Proceso actual</th>
            </tr>
        </tfoot>
    </table>
    </div>
  </body>
<script>
var table;
$( document ).ready(function() {
	
	menuFiltro();
	$('#tablaCrias tbody').on('click', 'td.details-control', function () {
        var tr = $(this).closest('tr');
        var row = table.row(tr);

        if (row.child.isShown()) {
            row.child.hide();
            tr.removeClass('shown');
        }
        else {
            row.child(formatInfo(row.data(), row.index())).show();
            tr.addClass('shown');
        }
    });
	
	$(document).on("click", "button.btn-success", function () {
		var rowIndex = $(this).data('row');
        var rowData = table.row(rowIndex).data();
        if(rowData.est_id == 3) {
        	 Swal.fire({
                 title: 'Sacar de Cuarentena',
                 text: "¿Estas seguro de mandar esta Cria como sana al corral general?",
                 type: 'question',
                 showCancelButton: true,
                 confirmButtonColor: '#3085d6',
                 cancelButtonColor: '#d33',
                 confirmButtonText: 'Confirmar',
                 cancelButtonText: 'Cancelar'
             }).then((result) => {
                 if (result.value) {
                	 sacarCuarentena(rowData, rowIndex);
                 }
             })
        	return;
        }
        (async() => {
            const { value: text } = await Swal.fire({
                title: 'Mandar cria a cuarentena',
                input: 'textarea',
                inputPlaceholder: 'Escriba el tratamiento y dieta que llevara la cria...',
                showCancelButton: true
            })

            if (text) {
                registrarCuarentena(rowData, rowIndex, text);
            }
        })()
    });
	
	$(document).on("click", "button.btn-danger", function () {
		var rowIndex = $(this).data('row');
        var rowData = table.row(rowIndex).data();
        
        Swal.fire({
            title: 'Sacrificar',
            text: "¿Estas seguro de sacrificar esta Cria?",
            type: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Confirmar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.value) {
           	 sacrificar(rowData, rowIndex, false);
            }
        })
	});
	
	$(document).on("click", "button.btn-info", function () {
		var rowIndex = $(this).data('row');
        var rowData = table.row(rowIndex).data();
        verLog(rowData.cri_id);
	});
	
	$(document).on("click", "button.btn-warning", function () {
		var rowIndex = $(this).data('row');
        var rowData = table.row(rowIndex).data();
        
        Swal.fire({
            title: 'Confirmación',
            text: "¿Esta seguro de mandar esta Cria al siguiente proceso?",
            type: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Confirmar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.value) {
            	subirProceso(rowData, rowIndex);
            }
        })
	});
});

function menuFiltro() {
	(async () => {
		const { value: valor } = await Swal.fire({
		  title: 'Consulta Crias',
		  input: 'select',
		  inputOptions: {
		    1: 'Todas',
		    2: 'Permanecieron mas de 5 meses'
		  },
		  inputPlaceholder: 'Seleccione una opcion',
		})

		if (valor) 
			cargarTabla(valor);
		else 
			menuFiltro();
	})()
}

function cargarTabla(valor) {
	var data = JSON.parse(window.java.cargarCrias(parseInt(valor)));
	table = $('#tablaCrias').DataTable( {
		"dom": 'Bfrtip',
		lengthChange: false,
        buttons: [ 
        	{
	        	extend: 'collection',
	        	text: 'Exportar',
	        	buttons: [
        		{
	                extend: 'copy',
	                text: 'Copiar',
	                exportOptions: {
	                    columns: ':visible'
	                }
	            },
	            {
	                extend: 'excel',
	                exportOptions: {
	                    columns: ':visible'
	                }
	            },
        		{
	                extend: 'pdf',
	                exportOptions: {
	                    columns: ':visible'
	                }
	            },	
	        	{
	                extend: 'print',
	                exportOptions: {
	                    columns: ':visible'
	                }
	            },
	            ]
			},
			'pageLength',
        	'colvis' 
       	],
       	"lengthMenu": [
            [ 10, 25, 50, -1 ],
            [ 'Ver 10', 'Ver 25', 'Ver 50', 'Ver Todos' ]
        ],
		"language": {
            "decimal":        "",
            "emptyTable":     "Sin registros",
            "info":           "Visualizando _START_ a _END_ de _TOTAL_ registros",
            "infoEmpty":      "Visualizando 0 a 0 de 0 registros",
            "infoFiltered":   "(filtrando de _MAX_ registros)",
            "infoPostFix":    "",
            "thousands":      ",",
            "lengthMenu":     "Visualizar _MENU_ registros por pagina",
            "loadingRecords": "Cargando...",
            "processing":     "Procesando...",
            "search":         "Buscar:",
            "zeroRecords":    "No se encontro ningun registro que coincida con su busqueda",
            "paginate": {
                "first":      "Primera",
                "last":       "Ultima",
                "next":       "Siguiente",
                "previous":   "Anterior"
            },
            "aria": {
                "sortAscending":  ": activar para ordenar ascendentemente",
                "sortDescending": ": activar para ordenar descendentemente"
            },
            "buttons": {
            	"colvis": "Columnas",
            	"print": "Imprimir",
            	"pageLength": {
                    _: "Visualizando %d registros por página",
                    '-1': "Visualizando todos"
                }
            }
        },
        "data": data,
        "columns": [
        	{
                "className": 'details-control',
                "orderable": false,
                "data": null,
                "defaultContent": ''
            },
            { "data": null, render: function(data, type, row) {
           		return "#" + data.cri_id;
        		} 
        	},
            { "data": "cla_descripcion" },
            { "data": "est_descripcion" },
            { "data": "cor_descripcion" },
            { "data": null, render: function(data, type, row) {
               		return "P" + data.proceso_actual;
            	} 
            }
        ],
        "order": [[1, 'desc']]
    } );
}

function subirProceso(rowData, rowIndex) {
	var data = window.java.subirProceso(rowData.cri_id);
	
	if(data == 1) {
		var proceso = "P" +(rowData.proceso_actual+1);
        Swal.fire({
            type: 'success',
            title: 'Listo',
            text: 'Cria No. ' +rowData.cri_id + ' Entro al proceso '+proceso,
            timer: 3000
        });
        
        rowData.proceso_actual = rowData.proceso_actual + 1;
        actualizarFila(rowData, rowIndex);
    }
    else
        Swal.fire({
            title: 'Error',
            text: "Esta cria no se puede mover al siguiente proceso",
            type: "error",
            animation: false,
            customClass: { popup: 'animated tada' }
        });
}

function sacarCuarentena(rowData, rowIndex) {
	var data = window.java.sacarCuarentena(rowData.cri_id);

    if(data == 1) {
        Swal.fire({
            type: 'success',
            title: 'Listo',
            text: 'Cria No. ' +rowData.cri_id + ' Movida al corral General',
            timer: 3000
        });
        
        rowData.est_id = 1
        rowData.est_descripcion = 'Actualizar página';
        rowData.cor_descripcion = 'Actualizar página';
        actualizarFila(rowData, rowIndex);
    }
    else
        Swal.fire({
            title: 'Error',
            text: "Hubo un error en la base de datos",
            type: "error",
            animation: false,
            customClass: { popup: 'animated tada' }
        });
}

function registrarCuarentena(rowData, rowIndex, dieta) {
	var data = window.java.registrarCuarentena(rowData.cri_id, dieta);

    if(data == 1) {
        Swal.fire({
            type: 'success',
            title: 'Listo',
            text: 'Cria No. ' +rowData.cri_id + ' Movida a cuarentena!',
            timer: 3000
        });
        
        rowData.est_id = 3
        rowData.est_descripcion = 'Actualizar página';
        rowData.cor_descripcion = 'Actualizar página';
        actualizarFila(rowData, rowIndex);
    }
    else
        Swal.fire({
            title: 'Error',
            text: "Hubo un error en la base de datos",
            type: "error",
            animation: false,
            customClass: { popup: 'animated tada' }
        });
}

function sacrificar(rowData, rowIndex, bandera) {
	if(!bandera && rowData.est_id == 1) {
		Swal.fire({
            title: 'Confirmacion',
            text: "Esta cria se encuentra en estado de Sana, ¿Aun Estas seguro de sacrificar esta Cria?",
            type: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Confirmar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.value) {
           	 sacrificar(rowData, rowIndex, true);
            }
        })
        
        return;
	}
	
	var data = window.java.sacrificar(rowData.cri_id);

    if(data == 1) {
        Swal.fire({
            type: 'success',
            title: 'Listo',
            text: 'Cria No. ' +rowData.cri_id + ' Sacrificada Correctamente!',
            timer: 3000
        });
        
        rowData.est_id = 4
        rowData.est_descripcion = 'Actualizar página';
        actualizarFila(rowData, rowIndex);
    }
    else
        Swal.fire({
            title: 'Error',
            text: "Hubo un error en la base de datos",
            type: "error",
            animation: false,
            customClass: { popup: 'animated tada' }
        });
}

function actualizarFila(rowData, rowIndex) {
	$("#tablaCrias").dataTable().fnUpdate(rowData, rowIndex, undefined, false);
	
    var trs = $("tr.shown");
    for(var i = 0; i < trs.length; i++) {
        var row = table.row(trs[i]);
        row.child(formatInfo(rowData, rowIndex)).show();
    }
}

function verLog(id) {
	var data = JSON.parse(window.java.cargarMovimientos(id));
	
	var html = '<table class="table"><thead class="thead-light"><tr>'+
    '<th scope="col">Movimiento</th><th scope="col">Fecha</th></thead><tbody>'

	data.forEach(function(a, index) {
		html += '<tr><td>' + a.movimiento+ '</td><td>' + a.fecha+ '</td></tr>';
	});

	html += '</tbody></table>';

	Swal.fire({
		title: '<strong>Movimientos</strong>',
		type: 'info',
		html: html,
		customClass: 'swal-wide'
	})
}

function formatInfo(d, rowIndex) {
	var formato = '<div class="row">';
	
	formato += '<div class="col-3"><button data-row='+rowIndex+' class="btn btn-info"><i class="fa fa-info-circle"></i> Movimientos (LOG)</button></div>';
	formato += '<div class="col-3"><button data-row='+rowIndex+' class="btn btn-warning"><i class="fa fa-arrow-circle-right"></i> Siguiente proceso</button></div>';
	if(d.est_id == 2) 
		formato += '<div class="col-3"><button data-row='+rowIndex+' class="btn btn-success"><i class="fa fa-thermometer-full"></i> Mandar a cuarentena</button></div>';
	else if(d.est_id == 3)
		formato += '<div class="col-3"><button data-row='+rowIndex+' class="btn btn-success"><i class="fa fa-thermometer-empty"></i> Sacar de cuarentena</button></div>';
	
	if(d.est_id != 4) 
		formato += '<div class="col-3"><button data-row='+rowIndex+' class="btn btn-danger"><i class="fa fa-heart-o"></i> Sacrificar</button></div>';
		
	formato += '</div><br>';
    formato += '<ul class="list-group list-group-horizontal-sm">' +
                  '<li class="list-group-item"><b>Peso:</b> ' + d.cri_peso +'</li>' +
                  '<li class="list-group-item"><b>Cantidad de Grasa:</b> ' + d.cri_grasa + '</li>' +
                  '<li class="list-group-item"><b>Color del Musculo:</b> ' + d.col_descripcion + '</li>' +
                  '<li class="list-group-item"><b>Dieta:</b> ' + d.cri_dieta + '</li></ul>';
    return formato;
}
</script>
</html>
